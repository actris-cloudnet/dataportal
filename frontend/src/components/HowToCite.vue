<style scoped lang="sass">
@import "../sass/variables.sass"
@import "../sass/global.sass"
</style>


<template>
  <!-- eslint-disable max-len -->
  <section id="howtocite">
    This is an example of how to cite Cloudnet datasets. You may edit the text to suit publication standards.
    <div class="infobox infocolor">
      <h4>Data availability</h4>
      <div class="citationtext">The ground-based remote-sensing data used in this article are generated by the European Research Infrastructure for the observation of Aerosol, Clouds and Trace Gases (ACTRIS) and are available from the ACTRIS Data Centre using the following link: <a :href="pid">{{ pid }}</a>.</div>
      <h4>Acknowledgements</h4>
      <div class="citationtext">
        We acknowledge ACTRIS for providing the {{ datasetCreator }} dataset in this study, which was produced by the Finnish Meteorological Institute, and is available for download from <a href="https://cloudnet.fmi.fi/">https://cloudnet.fmi.fi/</a>.
        {{ uniqueCitations.map(cit => cit.acknowledgements).join(' ') }}
      </div>
      <!--
[optional for ACTRIS sites .i.e. for discussion]
foreach SITE in SITES
The cloud radar, ceilometer and microwave radiometer data for [SITE] was provided by [PROVIDER]. [PROVIDER TEXT]
Additional text for Cloudnet data from ARM/NOAA/other sites:
* ARM *
The cloud radar, ceilometer and microwave radiometer data for the ARM site[s] used in this study ([SITES]) were obtained from the Atmospheric Radiation Measurement (ARM) user facility, managed by the Office of Biological and Environmental Research for the U.S. Department of Energy Office of Science.
* NOAA (Summit station, could be others in the future) *
The cloud radar, ceilometer and microwave radiometer data for the Summit Station were obtained from NOAA; overall programmatic and logistical support for was provided by the US National Science Foundation, with additional instrumental support provided by the NOAA Earth System Research Laboratories, the DOE Atmospheric Radiation Measurement Program, and Environment Canada.
* Other (European, campaign) stations *
The cloud radar, ceilometer and microwave radiometer data for [SITES] was provided by [PROVIDER]. [PROVIDER TEXT]
-->
      <h4>Citation</h4>
      <div class="citationtext">{{ datasetCreator }}: cloud profiling product{{ products.length > 1 ? 's' : ''}} {{ products.join(', ')}}; {{ startDate + (endDate ? ` - ${endDate}` : '') }}; {{ sites.map(site => site.humanReadableName).join(', ')}}. Generated by the cloud profiling unit of the ACTRIS Data Centre, <a :href="pid">{{ pid }}</a>, {{ year }}.</div>
    </div>
  </section>
</template>


<script lang="ts">
import {Component, Prop} from 'vue-property-decorator'
import Vue from 'vue'
import {Citation} from '../../../backend/src/entity/Citation'
import axios from 'axios'
import {Site} from '../../../backend/src/entity/Site'
import {Model} from '../../../backend/src/entity/Model'

@Component
export default class HowToCite extends Vue {
  @Prop() pid!: string
  @Prop() products!: string[]
  @Prop() siteIds!: string[]
  @Prop() modelIds!: string[]
  @Prop() startDate!: string
  @Prop() endDate!: string | null
  @Prop() collectionYear!: string | null
  citations: Citation[] = []
  sites: Site[] = []

  apiUrl = process.env.VUE_APP_BACKENDURL
  acknowledgements: string[] = []

  get year() {
    if (this.collectionYear) return this.collectionYear
    return new Date(this.startDate).getFullYear()
  }

  get datasetCreator() {
    return `CLU (${this.year})`
  }

  get uniqueCitations() {
    const uniqueIds = Array.from(new Set(this.citations.map(cit => cit.id)))
    return uniqueIds.map(id => this.citations.find(cit => cit.id == id))
  }

  mounted() {
    const queryOptions = { params: { showCitations: true }}

    Promise.all([
      axios.get(`${this.apiUrl}models/`, queryOptions),
      axios.get(`${this.apiUrl}sites/`, queryOptions)
    ]).then(([models, sites]) => {
      this.sites = sites.data.filter((site: Site) => this.siteIds.includes(site.id))
      const selectedModels = models.data.filter((model: Model) => this.modelIds.includes(model.id))
      const getCitations = (obj: Site | Model) => obj.citations as Citation[]
      this.citations = this.sites.filter(getCitations).map(getCitations)
        .concat(selectedModels.filter(getCitations).map(getCitations)).flat()
    })
  }

}
</script>
