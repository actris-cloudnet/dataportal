#!/usr/bin/env python3

import argparse
import urllib.request
import json
import os
import sys

BASE_URL = os.environ.get("DP_BACKEND_URL", "http://localhost:3000")
PERMISSIONS = [
    "canUpload",
    "canUploadModel",
    "canCalibrate",
    "canProcess",
    "canAddPublication",
    "canDelete",
    "canGetStats",
    "canPublishTask",
    "canLogin",
    "canReadLogs",
    "canWriteLogs",
]
LOG_PERMISSIONS = ["canReadLogs", "canWriteLogs"]


def get_all_users() -> list[dict]:
    req = urllib.request.Request(url=f"{BASE_URL}/user-accounts")
    with urllib.request.urlopen(req) as f:
        return json.load(f)


def get_user(username: str) -> dict:
    for user in get_all_users():
        if user["username"] == username:
            return user
    raise ValueError(f"User {username} not found")


def get_user_by_orcid(orcid: str) -> dict:
    for user in get_all_users():
        if user.get("orcidId") == orcid:
            return user
    raise ValueError(f"User with ORCID {orcid} not found")


def resolve_user(args: argparse.Namespace) -> dict:
    if getattr(args, "orcid", None):
        return get_user_by_orcid(args.orcid)
    elif getattr(args, "username", None):
        return get_user(args.username)
    else:
        print("Either username or --orcid is required", file=sys.stderr)
        sys.exit(1)


def put_user(user: dict) -> dict:
    req = urllib.request.Request(
        method="PUT",
        url=f"{BASE_URL}/user-accounts/{user['id']}",
        headers={"Content-Type": "application/json"},
        data=json.dumps(user).encode("utf-8"),
    )
    with urllib.request.urlopen(req) as f:
        return json.load(f)


def post_user(user: dict) -> dict:
    req = urllib.request.Request(
        method="POST",
        url=f"{BASE_URL}/user-accounts",
        headers={"Content-Type": "application/json"},
        data=json.dumps(user).encode("utf-8"),
    )
    with urllib.request.urlopen(req) as f:
        return json.load(f)


def print_user(user: dict) -> None:
    full_name = user.get("fullName", "")
    if user["username"]:
        print("Username: " + user["username"], end="")
    elif user.get("orcidId"):
        print("ORCID: " + user["orcidId"], end="")
    else:
        print("User ID: " + str(user["id"]), end="")
    if full_name:
        print(f" ({full_name})")
    else:
        print()
    permissions = user.get("permissions", [])
    log_perms = user.get("instrumentLogPermissions", [])

    if not permissions and not log_perms:
        print("No permissions")
        return

    print("Permissions:")
    for perm in permissions:
        site = "site: " + perm["siteId"] if perm["siteId"] else "all sites"
        model = "model: " + perm["modelId"] if perm["modelId"] else "all models"
        if perm["permission"] == "canUpload":
            scope = f"({site})"
        elif perm["permission"] == "canUploadModel":
            scope = f"({site}, {model})"
        else:
            scope = ""
        print(f"- {perm['permission']} {scope}".rstrip())
    for perm in log_perms:
        uuid = perm["instrumentInfoUuid"]
        scope = f"({('instrument: ' + uuid) if uuid else 'all instruments'})"
        print(f"- {perm['permission']} {scope}")


def list_users(args: argparse.Namespace) -> None:
    for user in get_all_users():
        print_user(user)
        print()


def user_info(args: argparse.Namespace) -> None:
    print_user(resolve_user(args))


def create_user(args: argparse.Namespace) -> None:
    user = {"username": args.username, "permissions": []}
    if args.password:
        user["password"] = args.password
    user = post_user(user)
    token = user.get("activationToken")
    if token:
        link = f"https://cloudnet.fmi.fi/credentials/{token}"
        print(f"Activation link: {link}")
    else:
        print_user(user)


def _is_log_permission(args: argparse.Namespace) -> bool:
    return args.permission in LOG_PERMISSIONS


def _validate_log_args(args: argparse.Namespace) -> None:
    if getattr(args, "site", None) or getattr(args, "all_sites", False):
        print(
            f"Cannot use --site or --all-sites with permission {args.permission}",
            file=sys.stderr,
        )
        sys.exit(1)
    if getattr(args, "model", None) or getattr(args, "all_models", False):
        print(
            f"Cannot use --model or --all-models with permission {args.permission}",
            file=sys.stderr,
        )
        sys.exit(1)
    if args.instrument_uuid is None and not args.all_instruments:
        print(
            "--instrument-uuid or --all-instruments is required",
            file=sys.stderr,
        )
        sys.exit(1)


def _validate_regular_args(args: argparse.Namespace) -> None:
    if getattr(args, "instrument_uuid", None) or getattr(
        args, "all_instruments", False
    ):
        print(
            f"Cannot use --instrument-uuid or --all-instruments with permission {args.permission}",
            file=sys.stderr,
        )
        sys.exit(1)


def add_permission(args: argparse.Namespace) -> None:
    user = resolve_user(args)
    if _is_log_permission(args):
        _validate_log_args(args)
        perms_to_add = make_log_permissions(args)
        log_perms = user.get("instrumentLogPermissions", [])
        opposite = "canWriteLogs" if args.permission == "canReadLogs" else "canReadLogs"
        uuids_to_add = {p["instrumentInfoUuid"] for p in perms_to_add}
        log_perms = [
            perm
            for perm in log_perms
            if not (
                perm["permission"] == opposite
                and perm["instrumentInfoUuid"] in uuids_to_add
            )
        ]
        log_perms.extend(perms_to_add)
        user["instrumentLogPermissions"] = log_perms
    else:
        _validate_regular_args(args)
        permissions_to_add = make_permissions(args)
        user["permissions"].extend(permissions_to_add)
    put_user(user)
    user = resolve_user(args)
    print_user(user)


def remove_permission(args: argparse.Namespace) -> None:
    user = resolve_user(args)
    if _is_log_permission(args):
        _validate_log_args(args)
        perms_to_remove = make_log_permissions(args)
        log_perms = user.get("instrumentLogPermissions", [])
        user["instrumentLogPermissions"] = [
            perm
            for perm in log_perms
            if not any(log_permission_equal(perm, p) for p in perms_to_remove)
        ]
    else:
        _validate_regular_args(args)
        permissions_to_remove = make_permissions(args)
        user["permissions"] = [
            perm
            for perm in user["permissions"]
            if not any(permission_equal(perm, p) for p in permissions_to_remove)
        ]
    put_user(user)
    user = resolve_user(args)
    print_user(user)


def permission_equal(a: dict, b: dict) -> bool:
    return (
        a["permission"] == b["permission"]
        and a["siteId"] == b["siteId"]
        and a["modelId"] == b["modelId"]
    )


def make_permissions(args: argparse.Namespace) -> list[dict]:
    if (
        args.permission in ("canUpload", "canUploadModel")
        and args.site is None
        and not args.all_sites
    ):
        print("--site or --all-sites is required", file=sys.stderr)
        sys.exit(1)
    if (
        args.permission == "canUploadModel"
        and args.model is None
        and not args.all_models
    ):
        print("--model or --all-models is required", file=sys.stderr)
        sys.exit(1)
    if (args.model or args.all_models) and args.permission != "canUploadModel":
        print(
            f"Cannot use --model or --all-models with permission {args.permission}",
            file=sys.stderr,
        )
        sys.exit(1)
    sites = [None] if args.site is None or args.all_sites else args.site
    models = [None] if args.model is None or args.all_models else args.model
    permissions = []
    for site in sites:
        for model in models:
            permissions.append(
                {"siteId": site, "modelId": model, "permission": args.permission}
            )
    return permissions


def log_permission_equal(a: dict, b: dict) -> bool:
    return (
        a["permission"] == b["permission"]
        and a["instrumentInfoUuid"] == b["instrumentInfoUuid"]
    )


def make_log_permissions(args: argparse.Namespace) -> list[dict]:
    uuids = [None] if args.all_instruments else args.instrument_uuid
    return [
        {"instrumentInfoUuid": uuid, "permission": args.permission} for uuid in uuids
    ]


def main():
    parser = argparse.ArgumentParser(prog="cloudnet-admin")
    subparsers = parser.add_subparsers(required=True, dest="command")

    subparser = subparsers.add_parser("list-users")
    subparser.set_defaults(func=list_users)

    subparser = subparsers.add_parser("user-info")
    subparser.add_argument("username", nargs="?")
    subparser.add_argument("--orcid")
    subparser.set_defaults(func=user_info)

    subparser = subparsers.add_parser("create-user")
    subparser.add_argument("username")
    subparser.add_argument("--password")
    subparser.set_defaults(func=create_user)

    subparser = subparsers.add_parser("add-permission")
    subparser.add_argument("username", nargs="?")
    subparser.add_argument("--orcid")
    subparser.add_argument("permission", choices=PERMISSIONS)
    group = subparser.add_mutually_exclusive_group()
    group.add_argument("--site", nargs="+")
    group.add_argument("--all-sites", action="store_true")
    group = subparser.add_mutually_exclusive_group()
    group.add_argument("--model", nargs="+")
    group.add_argument("--all-models", action="store_true")
    group = subparser.add_mutually_exclusive_group()
    group.add_argument("--instrument-uuid", nargs="+")
    group.add_argument("--all-instruments", action="store_true")
    subparser.set_defaults(func=add_permission)

    subparser = subparsers.add_parser("remove-permission")
    subparser.add_argument("username", nargs="?")
    subparser.add_argument("--orcid")
    subparser.add_argument("permission", choices=PERMISSIONS)
    group = subparser.add_mutually_exclusive_group()
    group.add_argument("--site", nargs="+")
    group.add_argument("--all-sites", action="store_true")
    group = subparser.add_mutually_exclusive_group()
    group.add_argument("--model", nargs="+")
    group.add_argument("--all-models", action="store_true")
    group = subparser.add_mutually_exclusive_group()
    group.add_argument("--instrument-uuid", nargs="+")
    group.add_argument("--all-instruments", action="store_true")
    subparser.set_defaults(func=remove_permission)

    args = parser.parse_args()
    args.func(args)


if __name__ == "__main__":
    main()
